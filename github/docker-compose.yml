services:
  # Base image with GitHub Actions Runner installed
  githubrunnerbase:
    build:
      context: actions
      args:
        rocky: $RL10
        image: docker-${DOCKER}
        RUNNER_VERSION: $GITHUB_RUNNER_TAG
        RUNNER_CHECKSUM: $GITHUB_RUNNER_SHA256
    image: "aursu/rockylinux:${RL10TAG}-actions-runner-${GITHUB_RUNNER_TAG}"

  # Configure runner (run once to register)
  # Usage: docker compose run --rm githubrunnerconfig
  githubrunnerconfig:
    image: "aursu/rockylinux:${RL10TAG}-actions-runner-${GITHUB_RUNNER_TAG}"
    command: /usr/local/runner/runner.py configure --replace
    env_file:
      - secrets/github.env
    volumes:
      - githubrunner:/home/runner

  # Remove/unregister runner
  # Usage: docker compose run --rm githubrunnerdelete
  githubrunnerdelete:
    image: "aursu/rockylinux:${RL10TAG}-actions-runner-${GITHUB_RUNNER_TAG}"
    command: /usr/local/runner/runner.py remove
    env_file:
      - secrets/github.env
    volumes:
      - githubrunner:/home/runner

  # Run the configured runner (long-running service)
  # Usage: docker compose up -d githubrunner
  githubrunner:
    image: "aursu/rockylinux:${RL10TAG}-actions-runner-${GITHUB_RUNNER_TAG}"
    command: /usr/local/runner/runner.py
    env_file:
      - secrets/github.env
    environment:
      DOCKER_TLS_CERTDIR: /certs
      DOCKER_CERT_PATH: /certs/client
      DOCKER_TLS_VERIFY: 1
      DOCKER_HOST: tcp://localhost:2376
    volumes:
      - githubrunner:/home/runner
      - /etc/docker/certs.d:/etc/docker/certs.d
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/docker/tls:/certs/client

volumes:
  githubrunner:
    name: githubrunner
